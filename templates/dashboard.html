{% extends "base.html" %}

{% block header_left %}
<div class="brand-row">
  <img class="logo-robot"
       src="{{ url_for('static', filename='img/' + (restaurant.logo or 'logo_robot.svg')) }}"
       alt="logo">
  <div class="brand-title">
    <span class="brand-strong">{{ restaurant.name or 'Ristorante' }}</span> —
    <span class="brand-sub">Dashboard ristorante</span>
  </div>

  <!-- MENU ⋮ -->
  <div class="kebab-wrap">
    <button id="btn-kebab"
            class="btn btn-icon"
            aria-haspopup="menu"
            aria-expanded="false"
            aria-label="Menu impostazioni">⋮</button>
    <div id="kebab-menu" class="kebab-menu" hidden role="menu" aria-labelledby="btn-kebab">
      <button class="k-item" data-act="weekly"  role="menuitem">Orari settimanali…</button>
      <button class="k-item" data-act="special" role="menuitem">Giorni speciali…</button>
      <button class="k-item" data-act="settings" role="menuitem">Impostazioni…</button>
      <hr>
      <button class="k-item" data-act="state"   role="menuitem">Stato & JSON…</button>
      <button class="k-item" data-act="help"    role="menuitem">Guida codici rapidi</button>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="dash-grid">
  <!-- Badge chiamate attive -->
  <section class="card soft-card" id="voice-badge" data-rid="{{ restaurant.id }}">
    <div class="soft-title">
      Chiamate attive:
      <span class="strong"><span id="vb-active">0</span>/<span id="vb-max">3</span></span>
    </div>
    <div class="soft-right">
      <span class="dot" id="vb-dot"></span>
      <span class="soft-label" id="vb-label">Disponibile</span>
    </div>
  </section>

  <!-- KPI -->
  <section class="kpi-grid {% if is_pizzeria %}kpi-3{% else %}kpi-2{% endif %}">
    <div class="card kpi-card">
      <div class="kpi-title">Prenotazioni oggi</div>
      <div class="kpi-value" id="kpi-today">0</div>
    </div>
    {% if is_pizzeria %}
    <div class="card kpi-card">
      <div class="kpi-title">Pizze ordinate</div>
      <div class="kpi-value" id="kpi-pizzas">0</div>
    </div>
    {% endif %}
    <div class="card kpi-card">
      <div class="kpi-title">Incasso stimato</div>
      <div class="kpi-value" id="kpi-revenue">€ 0</div>
    </div>
  </section>

  <!-- Prenotazioni -->
  <section class="card">
    <div class="card-head">
      <h3 class="card-title">Prenotazioni</h3>
      <div class="row">
        <input type="date" id="resv-date" class="input" value="{{ today }}">
        <button class="btn btn-outline" id="resv-refresh">Aggiorna</button>
      </div>
    </div>
    <div id="resv-table" class="table"></div>
  </section>
</div>

<!-- Weekly -->
<div id="modal-weekly" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="weekly-title">
    <div class="modal-head">
      <h3 class="card-title" id="weekly-title">Orari settimanali</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body">
      <p class="muted">Scrivi gli orari per ogni giorno (es: <code>12:00-15:00, 19:00-23:30</code>). Giorno vuoto = chiuso.</p>
      <div id="weekly-form" class="weekly-form"></div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="weekly-save">Salva</button>
      <button class="btn btn-outline js-close">Annulla</button>
    </div>
  </div>
</div>

<!-- Special Days -->
<div id="modal-special" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="special-title">
    <div class="modal-head">
      <h3 class="card-title" id="special-title">Giorni speciali</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label>Data</label>
        <input id="sp-date" type="date" class="input">
      </div>
      <div class="form-row">
        <label><input type="checkbox" id="sp-closed"> Chiudi tutto il giorno</label>
      </div>
      <div class="form-row">
        <label>Finestre (se aperto)</label>
        <input id="sp-ranges" type="text" class="input" placeholder="18:00-23:00, 12:00-15:00">
      </div>
      <div class="row">
        <button id="sp-add" class="btn">Aggiungi/aggiorna</button>
        <button id="sp-del" class="btn btn-outline">Elimina</button>
      </div>
      <hr>
      <div id="sp-list" class="list small"></div>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="modal-settings" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="modal-head">
      <h3 class="card-title" id="settings-title">Impostazioni prenotazioni</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body grid-2">
      <div>
        <label>Step (min)</label>
        <input id="st-step" type="number" class="input" value="15" min="1">
      </div>
      <div>
        <label>Ultimo anticipo (min)</label>
        <input id="st-last" type="number" class="input" value="15" min="0">
      </div>
      <div>
        <label>Capacità per slot</label>
        <input id="st-cap" type="number" class="input" value="6" min="1">
      </div>
      <div>
        <label>Persone min</label>
        <input id="st-minp" type="number" class="input" value="1" min="1">
      </div>
      <div>
        <label>Persone max</label>
        <input id="st-maxp" type="number" class="input" value="12" min="1">
      </div>
      <div class="col-span-2">
        <label>Timezone</label>
        <input id="st-tz" type="text" class="input" value="Europe/Rome" placeholder="Europe/Rome">
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn" id="settings-save">Salva</button>
      <button class="btn btn-outline js-close">Annulla</button>
    </div>
  </div>
</div>

<!-- State (debug) -->
<div id="modal-state" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="state-title">
    <div class="modal-head">
      <h3 class="card-title" id="state-title">Stato & JSON</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body">
      <pre id="state-json" class="codebox"></pre>
    </div>
  </div>
</div>

<!-- Help -->
<div id="modal-help" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-head">
      <h3 class="card-title" id="help-title">Guida codici rapidi</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body">
      <pre class="codebox">RID=1
WEEK mon 12:00-15:00,19:00-23:30
WEEK tue CLOSED
SPECIAL 2025-12-25 CLOSED
SPECIAL 2025-08-15 18:00-23:00
SETTINGS step=15 last=15 capacity=6 party=1-12 tz=Europe/Rome
      </pre>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script defer src="{{ url_for('static', filename='js/reservations.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ config['BUILD_VERSION'] }}"></script>
{% endblock %}
