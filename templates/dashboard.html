{% extends "base.html" %}

{% block header_left %}
<div class="brand-row">
  <img class="logo-robot"
       src="{{ url_for('static', filename='img/' + (restaurant.logo or 'logo_robot.svg')) }}"
       alt="logo">
  <div class="brand-title">
    <span class="brand-strong">{{ restaurant.name or 'Ristorante' }}</span> —
    <span class="brand-sub">Dashboard ristorante</span>
  </div>

  <!-- MENU ⋮ -->
  <div class="kebab-wrap">
    <button id="btn-kebab"
            class="btn btn-icon"
            aria-haspopup="menu"
            aria-expanded="false"
            aria-label="Menu impostazioni">⋮</button>
    <div id="kebab-menu" class="kebab-menu" hidden role="menu" aria-labelledby="btn-kebab">
      <button class="k-item" data-act="weekly"  role="menuitem">Orari settimanali…</button>
      <button class="k-item" data-act="special" role="menuitem">Giorni speciali…</button>
      <button class="k-item" data-act="settings" role="menuitem">Impostazioni…</button>
      <hr>
      <button class="k-item" data-act="state"   role="menuitem">Stato & riepilogo…</button>
      <button class="k-item" data-act="help"    role="menuitem">Guida codici rapidi</button>
    </div>
  </div>
</div>
{% endblock %}

{% block content %}
<div class="dash-grid">
  <!-- Badge chiamate attive -->
  <section class="card soft-card" id="voice-badge" data-rid="{{ restaurant.id }}">
    <div class="soft-title">
      Chiamate attive:
      <span class="strong"><span id="vb-active">0</span>/<span id="vb-max">3</span></span>
    </div>
    <div class="soft-right">
      <span class="dot dot-green" id="vb-dot"></span>
      <span class="soft-label" id="vb-label">Disponibile</span>
    </div>
  </section>

  <!-- KPI -->
  <section class="kpi-grid {% if is_pizzeria %}kpi-3{% else %}kpi-2{% endif %}">
    <div class="card kpi-card">
      <div class="kpi-title">Prenotazioni oggi</div>
      <div class="kpi-value" id="kpi-today">0</div>
    </div>
    {% if is_pizzeria %}
    <div class="card kpi-card">
      <div class="kpi-title">Pizze ordinate</div>
      <div class="kpi-value" id="kpi-pizzas">0</div>
    </div>
    {% endif %}
    <div class="card kpi-card">
      <div class="kpi-title">Incasso stimato</div>
      <div class="kpi-value" id="kpi-revenue">€ 0</div>
    </div>
  </section>

  <!-- Prenotazioni -->
  <section class="card">
    <div class="card-head">
      <h3 class="card-title">Prenotazioni</h3>
      <div class="row" style="flex-wrap:wrap; gap:8px 10px">
        <input type="date" id="resv-date" class="input" value="{{ today }}">
        <input type="text" id="resv-q" class="input" placeholder="Cerca nome / telefono / orario">
        <button class="btn btn-outline" id="resv-filter">Filtra</button>
        <button class="btn btn-outline" id="resv-clear">Elimina filtri</button>
        <button class="btn btn-outline" id="resv-last30">Storico 30gg</button>
        <button class="btn btn-outline" id="resv-today">Oggi</button>
        <button class="btn" id="resv-refresh">Aggiorna</button>
      </div>
    </div>
    <div id="resv-table" class="table"></div>
  </section>
</div>

<!-- ====== MODAL: Orari settimanali ====== -->
<div id="modal-weekly" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="weekly-title">
    <div class="modal-head">
      <h3 class="card-title" id="weekly-title">Orari settimanali</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body">
      <div class="muted small">
        Formato: <b>HH:MM-HH:MM</b> (es. <span class="chip">12:00-15:00</span>, <span class="chip">19:00-23:30</span>).
        Giorno vuoto = <b>CHIUSO</b>.
      </div>
      <div id="weekly-form" class="weekly-form"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-light js-close">Chiudi</button>
      <button class="btn" id="weekly-save">Salva</button>
    </div>
  </div>
</div>

<!-- ====== MODAL: Giorni speciali ====== -->
<div id="modal-special" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="special-title">
    <div class="modal-head">
      <h3 class="card-title" id="special-title">Giorni speciali</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body">
      <div class="grid-2">
        <div>
          <label>Data</label>
          <input id="sp-date" type="date" class="input" data-autofocus>
        </div>
        <div class="v-end">
          <label class="checkbox"><input type="checkbox" id="sp-closed"> Chiudi tutto il giorno</label>
        </div>
        <div class="col-span-2">
          <label>Finestre (se aperto)</label>
          <input id="sp-ranges" type="text" class="input" placeholder="18:00-23:00, 12:00-15:00">
        </div>
      </div>
      <hr>
      <div id="sp-list" class="sp-list"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-light js-close">Chiudi</button>
      <button id="sp-del" class="btn btn-danger-outline">Elimina</button>
      <button id="sp-add" class="btn">Aggiungi / Aggiorna</button>
    </div>
  </div>
</div>

<!-- ====== MODAL: Impostazioni ====== -->
<div id="modal-settings" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="modal-head">
      <h3 class="card-title" id="settings-title">Impostazioni prenotazioni</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body grid-2">
      <div><label>Step (min)</label><input id="st-step" type="number" class="input" min="1" value="15" data-autofocus></div>
      <div><label>Ultimo anticipo (min)</label><input id="st-last" type="number" class="input" min="0" value="15"></div>
      <div><label>Capacità per slot</label><input id="st-cap" type="number" class="input" min="1" value="6"></div>
      <div><label>Persone min</label><input id="st-minp" type="number" class="input" min="1" value="1"></div>
      <div><label>Persone max</label><input id="st-maxp" type="number" class="input" min="1" value="12"></div>
      <div class="col-span-2"><label>Timezone</label><input id="st-tz" type="text" class="input" value="Europe/Rome"></div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-light js-close">Chiudi</button>
      <button class="btn" id="settings-save">Salva</button>
    </div>
  </div>
</div>

<!-- ====== MODAL: Stato & riepilogo ====== -->
<div id="modal-state" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="state-title">
    <div class="modal-head">
      <h3 class="card-title" id="state-title">Stato & riepilogo</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body state-wrap">
      <div id="state-human"></div>
      <details class="state-json">
        <summary>Vedi JSON</summary>
        <pre id="state-json" class="codebox"></pre>
      </details>
    </div>
    <div class="modal-foot">
      <button class="btn btn-light js-close">Chiudi</button>
    </div>
  </div>
</div>

<!-- ====== MODAL: Guida codici rapidi ====== -->
<div id="modal-help" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-head">
      <h3 class="card-title" id="help-title">Guida codici rapidi</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">✖</button>
    </div>
    <div class="modal-body help-body">
      <div class="help-row">
        <div class="help-k">Cos’è</div>
        <div class="help-v">Comandi testuali equivalenti ai modali. Incolli una riga, aggiorni orari o regole in un colpo.</div>
      </div>
      <div class="help-row">
        <div class="help-k">Come usare</div>
        <div class="help-v">
          <ol style="margin:0; padding-left:18px">
            <li>Apri il menu ⋮ e scegli il pannello (Orari, Speciali, Impostazioni).</li>
            <li>Prendi un esempio sotto, modifica i valori e salva.</li>
            <li>Controlla in “Stato & riepilogo”.</li>
          </ol>
        </div>
      </div>
      <div class="help-row">
        <div class="help-k">WEEK</div>
        <div class="help-v">Orari settimanali (mon…sun):
          <div class="chip">mon 12:00-15:00,19:00-23:30</div>
          <div class="muted small">Lascia vuoto un giorno per chiuderlo.</div>
        </div>
      </div>
      <div class="help-row">
        <div class="help-k">SPECIAL</div>
        <div class="help-v">Giorno speciale:
          <div class="chip">2025-12-25 CLOSED</div>
          <div class="chip">2025-08-15 18:00-23:00</div>
        </div>
      </div>
      <div class="help-row">
        <div class="help-k">SETTINGS</div>
        <div class="help-v">Impostazioni:
          <div class="chip">step=15 last=15 capacity=6 party=1-12 tz=Europe/Rome</div>
        </div>
      </div>
    </div>
    <div class="modal-foot">
      <button class="btn btn-light js-close">Chiudi</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="_toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script defer src="{{ url_for('static', filename='js/reservations.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ config['BUILD_VERSION'] }}"></script>
{% endblock %}
