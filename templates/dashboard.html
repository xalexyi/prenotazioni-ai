{% extends "base.html" %}

{% block header_left %}
<div class="brand-row">
  <img class="logo-robot"
       src="{{ url_for('static', filename='img/' + (restaurant.logo or 'logo_robot.svg')) }}"
       alt="logo">
  <div class="brand-title">
    <span class="brand-strong">{{ restaurant.name or 'Ristorante' }}</span> ‚Äî
    <span class="brand-sub">Dashboard ristorante</span>
  </div>

  <!-- MENU ‚ãÆ -->
  <div class="kebab-wrap">
    <button id="btn-kebab" class="btn btn-icon" aria-haspopup="menu" aria-expanded="false" aria-label="Menu impostazioni">‚ãÆ</button>
    <div id="kebab-menu" class="kebab-menu" hidden role="menu" aria-labelledby="btn-kebab">
      <button class="k-item" data-act="weekly"  role="menuitem">Orari settimanali‚Ä¶</button>
      <button class="k-item" data-act="special" role="menuitem">Giorni speciali‚Ä¶</button>
      <button class="k-item" data-act="settings" role="menuitem">Impostazioni prenotazioni‚Ä¶</button>
      <hr>
      <button class="k-item" data-act="state" role="menuitem">Stato orari</button>
      <button class="k-item" data-act="help"  role="menuitem">Guida codici rapidi</button>
    </div>
  </div>
</div>
{% endblock %}

{% block header_right %}
<button id="themeToggle" class="toggle theme-toggle" aria-label="Tema Giorno/Notte" title="Giorno/Notte">
  <span class="toggle-icon sun">‚òÄÔ∏è</span>
  <span class="toggle-icon moon">üåô</span>
</button>
<a class="btn btn-red logout-btn" href="{{ url_for('auth.logout') }}">Logout</a>
{% endblock %}

{% block content %}
<div class="dash-grid">
  <!-- Badge chiamate attive -->
  <section class="card soft-card" id="voice-badge" data-rid="{{ restaurant.id }}">
    <div class="soft-title">
      Chiamate attive:
      <span class="strong"><span id="vb-active">0</span>/<span id="vb-max">3</span></span>
    </div>
    <div class="soft-right">
      <span class="dot" id="vb-dot"></span>
      <span class="soft-label" id="vb-label">Disponibile</span>
    </div>
  </section>

  <!-- KPI -->
  <section class="kpi-grid {% if is_pizzeria %}kpi-3{% else %}kpi-2{% endif %}">
    <div class="card kpi-card">
      <div class="kpi-title">Prenotazioni oggi</div>
      <div class="kpi-value" id="kpi-today">0</div>
    </div>

    {% if is_pizzeria %}
    <div class="card kpi-card">
      <div class="kpi-title">Pizze ordinate</div>
      <div class="kpi-value" id="kpi-pizzas">0</div>
    </div>
    {% endif %}

    <div class="card kpi-card">
      <div class="kpi-title">Incasso stimato</div>
      <div class="kpi-value" id="kpi-revenue">‚Ç¨ 0</div>
    </div>
  </section>

  <!-- Filtri -->
  <section class="card filters">
    <input id="f-date" class="input" type="date" value="{{ today or '' }}">
    <input id="f-text" class="input" type="text" placeholder="Cerca nome / telefono / orario">
    <button id="btn-filter" class="btn btn-gray">Filtra</button>
    <button id="btn-clear" class="btn btn-outline">Elimina filtri</button>
    <button id="btn-30" class="btn btn-outline">Storico 30gg</button>
    <button id="btn-today" class="btn btn-outline">Oggi</button>

    <button id="btn-new" class="btn btn-primary push-right">+ Nuova prenotazione</button>
  </section>

  <!-- Lista -->
  <section class="card">
    <div id="list" class="list"></div>
  </section>
</div>

<!-- ===== Modali gestione orari ===== -->

<!-- Weekly -->
<div id="modal-weekly" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="weekly-title">
    <div class="modal-head">
      <h3 class="card-title" id="weekly-title">Orari settimanali</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">‚úñ</button>
    </div>
    <div class="modal-body">
      <div id="weekly-form" class="weekly-grid"></div>
      <div class="muted">Formato: <strong>HH:MM-HH:MM</strong> (es. <code>12:00-15:00,19:00-23:30</code>).</div>
    </div>
    <div class="modal-foot">
      <button id="weekly-save" class="btn btn-primary">Salva</button>
    </div>
  </div>
</div>

<!-- Special days -->
<div id="modal-special" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="special-title">
    <div class="modal-head">
      <h3 class="card-title" id="special-title">Giorni speciali</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">‚úñ</button>
    </div>
    <div class="modal-body">
      <div class="form-row">
        <label>Data</label>
        <input id="sp-date" type="date" class="input">
      </div>
      <div class="form-row">
        <label><input type="checkbox" id="sp-closed"> Chiudi tutto il giorno</label>
      </div>
      <div class="form-row">
        <label>Finestre (se aperto)</label>
        <input id="sp-ranges" type="text" class="input" placeholder="18:00-23:00, 12:00-15:00">
      </div>
      <div class="row">
        <button id="sp-add" class="btn">Aggiungi/aggiorna</button>
        <button id="sp-del" class="btn btn-outline">Elimina</button>
      </div>
      <hr>
      <div id="sp-list" class="list small"></div>
    </div>
  </div>
</div>

<!-- Settings -->
<div id="modal-settings" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="settings-title">
    <div class="modal-head">
      <h3 class="card-title" id="settings-title">Impostazioni prenotazioni</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">‚úñ</button>
    </div>
    <div class="modal-body grid-2">
      <div>
        <label>Step (min)</label>
        <input id="st-step" type="number" class="input" value="15" min="1">
      </div>
      <div>
        <label>Ultimo anticipo (min)</label>
        <input id="st-last" type="number" class="input" value="15" min="0">
      </div>
      <div>
        <label>Capacit√† per slot</label>
        <input id="st-cap" type="number" class="input" value="6" min="1">
      </div>
      <div>
        <label>Persone min</label>
        <input id="st-minp" type="number" class="input" value="1" min="1">
      </div>
      <div>
        <label>Persone max</label>
        <input id="st-maxp" type="number" class="input" value="12" min="1">
      </div>
      <div>
        <label>Timezone</label>
        <input id="st-tz" type="text" class="input" value="Europe/Rome">
      </div>
    </div>
    <div class="modal-foot">
      <button id="st-save" class="btn btn-primary">Salva</button>
    </div>
  </div>
</div>

<!-- Stato / Help -->
<div id="modal-state" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="state-title">
    <div class="modal-head">
      <h3 class="card-title" id="state-title">Stato orari</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">‚úñ</button>
    </div>
    <div class="modal-body">
      <pre id="state-pre" class="code"></pre>
    </div>
  </div>
</div>

<div id="modal-help" class="modal-backdrop" aria-hidden="true">
  <div class="modal card" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="modal-head">
      <h3 class="card-title" id="help-title">Guida codici rapidi</h3>
      <button class="btn btn-icon js-close" aria-label="Chiudi">‚úñ</button>
    </div>
    <div class="modal-body">
      <pre class="code">RID=1
WEEK mon 12:00-15:00,19:00-23:30
WEEK tue CLOSED
SPECIAL 2025-12-25 CLOSED
SPECIAL 2025-08-15 18:00-23:00
SETTINGS step=15 last=15 capacity=6 party=1-12 tz=Europe/Rome</pre>
      <div class="muted">Questi comandi sono equivalenti alle azioni che trovi nei modali.</div>
    </div>
  </div>
</div>

<!-- Flag JS + accent -->
<script>
  window.IS_PIZZERIA = {{ 1 if is_pizzeria else 0 }} === 1;
  (function(){
    var slug = "{{ restaurant.slug or '' }}";
    if (slug === "pizzerianapoli") document.body.classList.add("accent-pizza");
  })();
</script>
{% endblock %}

{% block scripts %}
<script defer src="{{ url_for('static', filename='js/reservations.js') }}"></script>
<script defer src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
{% endblock %}
